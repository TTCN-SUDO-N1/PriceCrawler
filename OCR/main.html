<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>Product Crawl Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body class="bg-gray-100 p-6">
    <!-- Top buttons -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">üìä B√°o c√°o S·∫£n ph·∫©m</h1>
        <div class="space-x-2">
            <button onclick="openAddProductModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">‚ûï Th√™m s·∫£n ph·∫©m g·ªëc</button>
            <button onclick="refreshData()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">üîÑ L√†m m·ªõi</button>
        </div>
    </div>
    
    <!-- Help Info Box -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h2 class="text-lg font-semibold text-blue-700 mb-2">üìå H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
        <p class="text-blue-600 mb-2">C√°ch th·ª©c ho·∫°t ƒë·ªông c·ªßa h·ªá th·ªëng:</p>
        <ol class="list-decimal list-inside text-blue-600 ml-4 space-y-1">
            <li><strong>Th√™m s·∫£n ph·∫©m g·ªëc</strong> - ƒê√¢y l√† s·∫£n ph·∫©m c·ªßa b·∫°n m√† b·∫°n mu·ªën theo d√µi gi√°.</li>
            <li><strong>Th√™m s·∫£n ph·∫©m ƒë·ªëi th·ªß</strong> - Cho t·ª´ng s·∫£n ph·∫©m g·ªëc, th√™m link c·ªßa ƒë·ªëi th·ªß b√°n s·∫£n ph·∫©m t∆∞∆°ng t·ª±.</li>
            <li><strong>Ph√¢n t√≠ch gi√°</strong> - H·ªá th·ªëng s·∫Ω crawl th√¥ng tin gi√° c·∫£ v√† l∆∞u l·ªãch s·ª≠ ƒë·ªÉ so s√°nh.</li>
        </ol>
        <div class="mt-3 text-blue-700 font-medium">
            L∆∞u √Ω: M·ªói s·∫£n ph·∫©m ƒë·ªëi th·ªß ph·∫£i li√™n k·∫øt v·ªõi m·ªôt s·∫£n ph·∫©m g·ªëc. H·ªá th·ªëng kh√¥ng th·ªÉ ph√¢n t√≠ch s·∫£n ph·∫©m kh√¥ng c√≥ m·ªëi quan h·ªá v·ªõi nhau.
        </div>
    </div>

    <!-- Products Container -->
    <div id="productsContainer">
        <!-- Product cards will be loaded here -->
        <div class="text-center py-10 text-gray-500">Loading products...</div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl">
            <h3 class="text-xl font-semibold mb-4">Th√™m s·∫£n ph·∫©m g·ªëc</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√™n s·∫£n ph·∫©m:</label>
                    <input type="text" id="productName" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="iPhone 15 Pro" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">SKU:</label>
                    <input type="text" id="productSKU" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="IP15P-256G" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Link s·∫£n ph·∫©m:</label>
                    <input type="text" id="productLink" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="https://myshop.com/iphone15" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° g·ªëc:</label>
                    <input type="text" id="productOrigPrice" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="32,000,000 VND" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Gi√° hi·ªán t·∫°i:</label>
                    <input type="text" id="productCurPrice" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="29,990,000 VND" />
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button onclick="closeAddProductModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">H·ªßy</button>
                <button onclick="addProduct()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">üíæ L∆∞u s·∫£n ph·∫©m</button>
            </div>
        </div>
    </div>

    <!-- Add Enemy Link Modal -->
    <div id="addEnemyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-xl">
            <h3 class="text-xl font-semibold mb-4">Th√™m s·∫£n ph·∫©m ƒë·ªëi th·ªß</h3>
            <input type="hidden" id="currentProductId" value="" />
            <label class="block text-sm font-medium text-gray-700 mb-1">Link s·∫£n ph·∫©m:</label>
            <input type="text" id="enemyLink" class="w-full border border-gray-300 rounded px-3 py-2 mb-4" placeholder="https://example.com/product123" />
            <div class="flex justify-end space-x-2">
                <button onclick="closeEnemyModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">H·ªßy</button>
                <button onclick="addEnemyLink()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">üöÄ Ch·∫°y Crawl</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global state
        let currentProductId = null;

        // Load all products on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            addCrawlButtonToForm();
        });

        function loadProducts() {
            axios.get('/api/products')
                .then(function(response) {
                    const products = response.data.products;
                    const container = document.getElementById('productsContainer');
                    
                    if (products.length === 0) {
                        container.innerHTML = '<div class="text-center py-10 text-gray-500">No products found. Add a product to get started.</div>';
                        return;
                    }
                    
                    let html = '';
                    products.forEach(product => {
                        html += createProductCard(product);
                    });
                    
                    container.innerHTML = html;
                    
                    // Load enemy products for each product
                    products.forEach(product => {
                        loadEnemyProducts(product.id);
                    });
                })
                .catch(function(error) {
                    console.error('Error loading products:', error);
                    document.getElementById('productsContainer').innerHTML = 
                        '<div class="text-center py-10 text-red-500">Error loading products. Please try again.</div>';
                });
        }

        function createProductCard(product) {
            return `
                <div class="bg-white p-6 rounded-xl shadow-md mb-6" id="product-${product.id}">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold">üõçÔ∏è ${product.name}</h2>
                        <button onclick="crawlAllEnemies(${product.id})" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">üöÄ Crawl All</button>
                    </div>
                    <div class="text-gray-700 mt-3 space-y-1">
                        <p><strong>SKU:</strong> ${product.sku || 'N/A'}</p>
                        <p><strong>Link:</strong> <a href="${product.link}" target="_blank" class="text-blue-600 hover:underline">${product.link || 'N/A'}</a></p>
                        <p><strong>Gi√° g·ªëc:</strong> ${product.org_price || 'N/A'}</p>
                        <p><strong>Gi√° hi·ªán t·∫°i:</strong> ${product.cur_price || 'N/A'}</p>
                    </div>
                    <div class="mt-4">
                        <button onclick="openEnemyModal(${product.id})" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            ‚ûï Th√™m link s·∫£n ph·∫©m ƒë·ªëi th·ªß
                        </button>
                    </div>
                    
                    <!-- Enemy Products Table -->
                    <div class="mt-6">
                        <h3 class="text-lg font-medium mb-2">S·∫£n ph·∫©m ƒë·ªëi th·ªß</h3>
                        <div id="enemyProducts-${product.id}" class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="text-center py-4 text-gray-500">Loading competitor products...</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function loadEnemyProducts(productId) {
            axios.get(`/api/products/${productId}/enemies`)
                .then(function(response) {
                    const enemies = response.data.enemies;
                    const container = document.getElementById(`enemyProducts-${productId}`);
                    
                    if (enemies.length === 0) {
                        container.innerHTML = '<div class="text-center py-4 text-gray-500">No competitor products found.</div>';
                        return;
                    }
                    
                    let html = `
                        <table class="min-w-full text-sm text-left text-gray-700">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-6 py-3">T√™n s·∫£n ph·∫©m</th>
                                    <th class="px-6 py-3">Link</th>
                                    <th class="px-6 py-3">Gi√°</th>
                                    <th class="px-6 py-3">Th·ªùi gian crawl</th>
                                    <th class="px-6 py-3 text-center">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                    `;
                    
                    enemies.forEach(enemy => {
                        html += `
                            <tr>
                                <td class="px-6 py-4">${enemy.product_name || enemy.enemy_name}</td>
                                <td class="px-6 py-4">
                                    <a href="${enemy.link}" target="_blank" class="text-blue-600 hover:underline">${enemy.link}</a>
                                </td>
                                <td class="px-6 py-4">${enemy.price || 'N/A'}</td>
                                <td class="px-6 py-4">${enemy.crawl_time}</td>
                                <td class="px-6 py-4 text-center">
                                    <button onclick="crawlSingleUrl('${enemy.link}', ${enemy.crawl_id})" 
                                            class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Crawl this
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(function(error) {
                    console.error(`Error loading enemy products for product ${productId}:`, error);
                    document.getElementById(`enemyProducts-${productId}`).innerHTML = 
                        '<div class="text-center py-4 text-red-500">Error loading competitor products.</div>';
                });
        }

        function openAddProductModal() {
            document.getElementById('addProductModal').classList.remove('hidden');
            document.getElementById('addProductModal').classList.add('flex');
        }

        function closeAddProductModal() {
            document.getElementById('addProductModal').classList.add('hidden');
            document.getElementById('addProductModal').classList.remove('flex');
            // Clear form fields
            document.getElementById('productName').value = '';
            document.getElementById('productSKU').value = '';
            document.getElementById('productLink').value = '';
            document.getElementById('productOrigPrice').value = '';
            document.getElementById('productCurPrice').value = '';
        }

        function addProduct() {
            const name = document.getElementById('productName').value;
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n s·∫£n ph·∫©m');
                return;
            }
            
            const productData = {
                name: name,
                sku: document.getElementById('productSKU').value,
                link: document.getElementById('productLink').value,
                org_price: document.getElementById('productOrigPrice').value,
                cur_price: document.getElementById('productCurPrice').value
            };
            
            axios.post('/api/products', productData)
                .then(function(response) {
                    alert('S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng!');
                    closeAddProductModal();
                    loadProducts(); // Reload all products
                })
                .catch(function(error) {
                    console.error('Error adding product:', error);
                    alert('L·ªói khi th√™m s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        function openEnemyModal(productId) {
            currentProductId = productId;
            document.getElementById('currentProductId').value = productId;
            document.getElementById('addEnemyModal').classList.remove('hidden');
            document.getElementById('addEnemyModal').classList.add('flex');
        }

        function closeEnemyModal() {
            document.getElementById('addEnemyModal').classList.add('hidden');
            document.getElementById('addEnemyModal').classList.remove('flex');
            document.getElementById('enemyLink').value = '';
        }

        function addEnemyLink() {
            const link = document.getElementById('enemyLink').value;
            const productId = document.getElementById('currentProductId').value;
            
            if (!link) {
                alert('Vui l√≤ng nh·∫≠p link s·∫£n ph·∫©m.');
                return;
            }
            
            axios.post(`/api/products/${productId}/enemies`, { link: link })
                .then(function(response) {
                    // After adding the link, crawl the URL right away
                    return axios.post('/api/crawl', { 
                        url: link,
                        crawl_id: response.data.crawl_id 
                    });
                })
                .then(function(response) {
                    alert('Link s·∫£n ph·∫©m ƒë·ªëi th·ªß ƒë√£ ƒë∆∞·ª£c th√™m v√† crawl th√†nh c√¥ng!');
                    closeEnemyModal();
                    loadEnemyProducts(productId); // Reload enemy products for this product
                })
                .catch(function(error) {
                    console.error('Error adding enemy link:', error);
                    alert('L·ªói khi th√™m ho·∫∑c crawl link s·∫£n ph·∫©m ƒë·ªëi th·ªß. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        function crawlSingleUrl(url, crawlId) {
            axios.post('/api/crawl', { url: url, crawl_id: crawlId })
                .then(function(response) {
                    alert('ƒê√£ crawl d·ªØ li·ªáu th√†nh c√¥ng!');
                    loadProducts(); // Reload all data
                })
                .catch(function(error) {
                    console.error('Error crawling URL:', error);
                    alert('L·ªói khi crawl d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        function crawlAllEnemies(productId) {
            axios.post(`/api/crawl/all/${productId}`)
                .then(function(response) {
                    alert(`ƒê√£ b·∫Øt ƒë·∫ßu crawl ${response.data.crawled.length} URLs!`);
                    setTimeout(() => {
                        loadEnemyProducts(productId); // Reload enemy products after a delay
                    }, 5000); // Give it 5 seconds to complete some crawling
                })
                .catch(function(error) {
                    console.error('Error crawling all enemies:', error);
                    alert('L·ªói khi crawl d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        function refreshData() {
            axios.get('/api/refresh')
                .then(function(response) {
                    loadProducts(); // Reload all products and their enemy products
                    alert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi!');
                })
                .catch(function(error) {
                    console.error('Error refreshing data:', error);
                    alert('L·ªói khi l√†m m·ªõi d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
                });
        }

        // Add a crawl button to the product form
        function addCrawlButtonToForm() {
            const saveBtn = document.querySelector('[onclick="addProduct()"]');
            const crawlBtn = document.createElement('button');
            crawlBtn.type = 'button';
            crawlBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mr-2';
            crawlBtn.innerHTML = 'üöÄ Crawl s·∫£n ph·∫©m';
            crawlBtn.onclick = crawlOriginalProduct;
            
            saveBtn.parentNode.insertBefore(crawlBtn, saveBtn);
        }

        // Function to crawl an original product
        function crawlOriginalProduct() {
            const link = document.getElementById('productLink').value;
            const name = document.getElementById('productName').value;
            const sku = document.getElementById('productSKU').value;
            
            if (!link) {
                alert('Vui l√≤ng nh·∫≠p link s·∫£n ph·∫©m');
                return;
            }
            
            // Show loading state
            const crawlBtn = document.querySelector('[onclick="crawlOriginalProduct"]');
            const originalText = crawlBtn.innerHTML;
            crawlBtn.disabled = true;
            crawlBtn.innerHTML = '‚è≥ ƒêang crawl...';
            
            // Call the API to crawl the product
            axios.post('/api/crawl/original', {
                link: link,
                name: name,
                sku: sku
            })
            .then(function(response) {
                alert('S·∫£n ph·∫©m ƒë√£ ƒë∆∞·ª£c crawl th√†nh c√¥ng!');
                closeAddProductModal();
                loadProducts(); // Reload all products
            })
            .catch(function(error) {
                console.error('Error crawling product:', error);
                alert('L·ªói khi crawl s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i.');
            })
            .finally(function() {
                // Reset button state
                crawlBtn.disabled = false;
                crawlBtn.innerHTML = originalText;
            });
        }
    </script>
</body>

</html>